{"ast":null,"code":"var getDate = require(\"./NameToDate.js\");\n\nfunction ReportWorkAbsences(filename, sheetIndex) {\n  //Data Declaration\n  var result = null;\n  var data = [];\n\n  var Pool = require(\"pg\").Pool;\n\n  var XLSX = require(\"xlsx\");\n\n  var pool = new Pool({\n    host: \"localhost\",\n    user: \"postgres\",\n    database: \"postgres\",\n    password: \"Vwf7j5yb#M\",\n    port: 5432\n  });\n\n  if (filename.slice(-4) == \"xlsx\") {\n    var workbook = XLSX.readFile(filename); //Loop through all sheets in the file\n\n    var ws = workbook.Sheets[workbook.SheetNames[sheetIndex]]; //Get the array of dates from the name of the sheet\n\n    var dateList = getDate.NameToDate(workbook.SheetNames[sheetIndex]); //Split the excel sheet into a 2d array\n\n    var csv = XLSX.utils.sheet_to_csv(ws);\n    csv = csv.split(\"\\n\");\n\n    for (var _j = 0; _j < csv.length; _j++) {\n      data.push(csv[_j].split(\",\"));\n    } //Remove all of the empty rows at the end of the sheet\n\n\n    var j = data.length - 1;\n\n    while (data[j][0] == '') {\n      data.pop();\n      j--;\n    } //Remove the two headers of the worksheet\n\n\n    for (var _j2 = 0; _j2 < 2; _j2++) {\n      data.shift();\n    } //Stored Procedure would go here\n\n\n    var query = \"INSERT INTO work_abscense(Absence_ID, Staff_ID, Period1, \" + \"Period2, Period3, Period4, date) VALUES (DEFAULT, $1, $2, $3, $4, $5, $6)\";\n    var query2 = \"SELECT Staff_ID FROM staff WHERE username = $1\";\n    pool.connect(function (err, pool, done) {\n      if (err) throw err;\n\n      try {\n        data.forEach(function (row) {\n          var user = [];\n          var id;\n          user.push(row[0]);\n          pool.query(query2, user, function (err, res) {\n            if (err) {\n              console.log(err.stack);\n            } else {\n              id = res.rows[0];\n\n              if (id != undefined) {\n                var _loop = function _loop(_j3) {\n                  var x = 4 * _j3;\n                  var absenceList = [];\n                  absenceList.push(id.staff_id);\n                  absenceList.push(row[x + 1]);\n                  absenceList.push(row[x + 2]);\n                  absenceList.push(row[x + 3]);\n                  absenceList.push(row[x + 4]);\n                  absenceList.push(dateList[_j3]);\n                  pool.query(query, absenceList, function (err, res) {\n                    if (err) {\n                      console.log(err.stack);\n                    } else {\n                      console.log(\"inserted for user: \" + user[0] + \"\\n\" + \" row:\", absenceList + \"\\n\");\n                    }\n                  });\n                };\n\n                for (var _j3 = 0; _j3 < 5; _j3++) {\n                  _loop(_j3);\n                }\n              } else {\n                console.log(\"Error on user row: \" + user[0] + \"\\n Failed insert: \" + \"The given user does not exist.\\n\");\n              }\n            }\n          });\n        });\n      } finally {\n        done();\n      }\n    });\n    result = \"File Successfully Inserted\";\n  } else {\n    result = \"Invalid File Type Given\";\n  }\n\n  return result;\n}\n\nconsole.log(ReportWorkAbsences(\"Example_Absences_(Fall_2017-018).xlsx\", 0));\nexports.ReportWorkAbsences = \"ReportWorkAbsences\";","map":{"version":3,"names":["getDate","require","ReportWorkAbsences","filename","sheetIndex","result","data","Pool","XLSX","pool","host","user","database","password","port","slice","workbook","readFile","ws","Sheets","SheetNames","dateList","NameToDate","csv","utils","sheet_to_csv","split","j","length","push","pop","shift","query","query2","connect","err","done","forEach","row","id","res","console","log","stack","rows","undefined","x","absenceList","staff_id","exports"],"sources":["C:/Users/MicSc/Documents/SWE4103/Project/SWE4103-On-Track/ontrack/src/functions/ReportWorkAbsences.js"],"sourcesContent":["let getDate = require(\"./NameToDate.js\");\r\n\r\nfunction ReportWorkAbsences(filename, sheetIndex)\r\n{\r\n    //Data Declaration\r\n    let result = null;\r\n    const data = [];\r\n    const Pool = require(\"pg\").Pool;\r\n    var XLSX = require(\"xlsx\");\r\n\r\n    const pool = new Pool({\r\n        host: \"localhost\",\r\n        user: \"postgres\",\r\n        database: \"postgres\",\r\n        password: \"Vwf7j5yb#M\",\r\n        port: 5432\r\n      });\r\n\r\n    if(filename.slice(-4) == \"xlsx\")\r\n    {\r\n        var workbook = XLSX.readFile(filename);\r\n\r\n        //Loop through all sheets in the file\r\n        var ws = workbook.Sheets[workbook.SheetNames[sheetIndex]];\r\n\r\n        //Get the array of dates from the name of the sheet\r\n        let dateList = getDate.NameToDate(workbook.SheetNames[sheetIndex]);\r\n\r\n        //Split the excel sheet into a 2d array\r\n        var csv = XLSX.utils.sheet_to_csv(ws);\r\n\r\n        csv = csv.split(\"\\n\");\r\n\r\n        for(let j = 0; j < csv.length; j++)\r\n        {\r\n            data.push(csv[j].split(\",\"));\r\n        }\r\n\r\n        //Remove all of the empty rows at the end of the sheet\r\n        let j = data.length - 1;\r\n\r\n        while(data[j][0] ==  '')\r\n        {\r\n            data.pop();\r\n\r\n            j--;\r\n        }\r\n\r\n        //Remove the two headers of the worksheet\r\n        for(let j = 0; j < 2; j++)\r\n        {\r\n            data.shift();\r\n        }\r\n\r\n        //Stored Procedure would go here\r\n        const query = \"INSERT INTO work_abscense(Absence_ID, Staff_ID, Period1, \" +\r\n                      \"Period2, Period3, Period4, date) VALUES (DEFAULT, $1, $2, $3, $4, $5, $6)\"\r\n\r\n        const query2 = \"SELECT Staff_ID FROM staff WHERE username = $1\"\r\n\r\n        pool.connect((err, pool, done) => {\r\n            if (err) throw err;\r\n                  \r\n             try {\r\n                    data.forEach(row => {\r\n                        const user = [];\r\n                        var id;\r\n\r\n                        user.push(row[0]);\r\n                        \r\n                        pool.query(query2, user, (err, res) => {\r\n                            if (err) {\r\n                                console.log(err.stack);\r\n                            } else {\r\n                                id = res.rows[0];\r\n\r\n                                if(id != undefined)\r\n                                {\r\n                                    for(let j = 0; j < 5; j++)\r\n                                    {\r\n                                        let x = 4 * j;\r\n                                        let absenceList = [];\r\n\r\n                                        absenceList.push(id.staff_id);\r\n                                        absenceList.push(row[x + 1]);\r\n                                        absenceList.push(row[x + 2]);\r\n                                        absenceList.push(row[x + 3]);\r\n                                        absenceList.push(row[x + 4]);\r\n                                        absenceList.push(dateList[j]);\r\n\r\n                                        pool.query(query, absenceList, (err, res) => {\r\n                                            if (err) {\r\n                                                console.log(err.stack);\r\n                                            } else {\r\n                                                console.log(\"inserted for user: \" + user[0] + \"\\n\" +\r\n                                                            \" row:\", absenceList + \"\\n\");\r\n                                            }\r\n                                        });\r\n                                    }\r\n                                }\r\n                                else\r\n                                {\r\n                                    console.log(\"Error on user row: \" + user[0] + \"\\n Failed insert: \" +\r\n                                                \"The given user does not exist.\\n\");\r\n                                }\r\n                            }\r\n                        });\r\n                    });\r\n                } finally {\r\n                    done();\r\n             }\r\n        });\r\n\r\n        result = \"File Successfully Inserted\";\r\n    }\r\n    else\r\n    {\r\n        result = \"Invalid File Type Given\";\r\n    }\r\n\r\n    return result;\r\n}\r\n\r\nconsole.log(ReportWorkAbsences(\"Example_Absences_(Fall_2017-018).xlsx\", 0));\r\n\r\nexports.ReportWorkAbsences = \"ReportWorkAbsences\";"],"mappings":"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"},"metadata":{},"sourceType":"module"}